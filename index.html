<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Gravitational Slingshot Simulation</title>
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
  <style>
    body {
      margin: 0;
      background: #0a0a0a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    #menu { margin-top: 50px; text-align: center; }
    #menu button {
      background: #1e90ff; border: none; color: white; font-weight: 600; font-size: 18px;
      padding: 12px 28px; margin: 0 15px; border-radius: 8px; cursor: pointer;
      box-shadow: 0 4px 8px rgba(30,144,255,0.4);
    }
    #menu button:hover { background: #3ea0ff; }
    #instructionsBox { display:none; max-width:600px; background:#1a1a1a; padding:20px; border-radius:12px; margin:20px; }
    #instructionsBox h3 { color:#1e90ff; text-align:center; }
    #ui { display:none; background:#121212; padding:20px; border-radius:16px; margin:20px; }
    #ui label { display:flex; align-items:center; margin-bottom:12px; }
    #ui input, #ui select { margin-left:10px; background:#222; color:#eee; border:1px solid #444; border-radius:6px; padding:4px 8px; width:100px; }
    #ui button { background:#1e90ff; color:white; border:none; border-radius:8px; padding:8px 16px; margin:0 10px; cursor:pointer; }
    #ui button:hover { background:#3ea0ff; }
    .value { margin-left:12px; font-family:monospace; color:#ffd633; }
    canvas { display:none; border:2px solid #1e90ff; border-radius:12px; background:black; }
  </style>
</head>
<body>
  <!-- Start Menu -->
  <div id="menu">
    <button id="startBtn">Start Simulation</button>
    <button id="instBtn">Show Instructions</button>
  </div>

  <!-- Instructions -->
  <div id="instructionsBox">
    <h3>Simulation Instructions</h3>
    <ul>
      <li>Click once on the canvas → red dot marks the ship's starting position.</li>
      <li>Move the mouse → a green line shows launch velocity direction & magnitude.</li>
      <li>Click again → ship is launched with shown velocity (in m/s).</li>
      <li>Planet(s) are fixed; gravitational force acts on ships.</li>
      <li>Enter numbers in base + exponent form (e.g., 5.97 and 24 → 5.97×10^24).</li>
    </ul>
  </div>

  <!-- UI -->
  <div id="ui">
    <label>Planet 1 Mass (Jupiter, kg):
      <input type="text" id="planet1Base" value="1.90" /> ×10^
      <input type="text" id="planet1Exp" value="27" />
      <span id="planet1Real" class="value"></span>
    </label>
    <label id="planet2Row" style="display:none;">Planet 2 Mass (Mars, kg):
      <input type="text" id="planet2Base" value="6.39" /> ×10^
      <input type="text" id="planet2Exp" value="23" />
      <span id="planet2Real" class="value"></span>
    </label>
    <label>Ship Mass (kg):
      <input type="text" id="shipBase" value="1" /> ×10^
      <input type="text" id="shipExp" value="3" />
      <span id="shipReal" class="value"></span>
    </label>
    <label>G (N·m²/kg²):
      <input type="text" id="gravBase" value="6.67" /> ×10^
      <input type="text" id="gravExp" value="-11" />
      <span id="gravReal" class="value"></span>
    </label>
    <label>Time Step Scale:
      <input type="range" id="timeStepScale" min="1" max="100" value="40" />
      <span id="timeStepValue" class="value">4000.0</span>
    </label>
    <label>Number of Planets:
      <select id="planetCount">
        <option value="1">1</option>
        <option value="2">2</option>
      </select>
    </label>
    <div>
      <button id="reset">Reset Ships</button>
      <button id="restart">Restart Defaults</button>
    </div>
  </div>

  <!-- Canvas -->
  <canvas id="sim" width="1280" height="720"></canvas>

  <!-- Python -->
  <script type="py">
import math
from js import document, window, Image
from pyodide.ffi import create_proxy

WIDTH, HEIGHT = 1280, 720
canvas = document.getElementById("sim")
ctx = canvas.getContext("2d")

# Inputs
planet1_base = document.getElementById("planet1Base")
planet1_exp  = document.getElementById("planet1Exp")
planet1_real = document.getElementById("planet1Real")

planet2_base = document.getElementById("planet2Base")
planet2_exp  = document.getElementById("planet2Exp")
planet2_real = document.getElementById("planet2Real")

ship_base = document.getElementById("shipBase")
ship_exp  = document.getElementById("shipExp")
ship_real = document.getElementById("shipReal")

grav_base = document.getElementById("gravBase")
grav_exp  = document.getElementById("gravExp")
grav_real = document.getElementById("gravReal")

time_step_scale = document.getElementById("timeStepScale")
time_step_value = document.getElementById("timeStepValue")

planet_count = document.getElementById("planetCount")

reset_btn = document.getElementById("reset")
restart_btn = document.getElementById("restart")

# Images
bg_img = Image.new(); bg_img.src = "background.png"
jupiter_img = Image.new(); jupiter_img.src = "jupiter.png"
mars_img = Image.new(); mars_img.src = "mars.jpg"

# Scaling
PIXEL_TO_M = 1e7  # Increased scale for better two-planet behavior
DRAG_TO_V = 0.5   # Reduced velocity scaling
MAX_TRAIL = 300

# Defaults - Using more realistic planetary masses
DEFAULT_PLANET1 = (1.90, 27)  # Jupiter mass
DEFAULT_PLANET2 = (6.39, 23)  # Mars mass
DEFAULT_SHIP = (1.0, 3)
DEFAULT_G = (6.67, -11)

def get_value(base_el, exp_el, fallback):
    try:
        base = float(str(base_el.value))
        exp = int(str(exp_el.value))
        return base * (10**exp)
    except:
        return fallback

def get_time_step():
    try:
        scale = float(str(time_step_scale.value))
        return scale * 100.0  # Scale factor for time step
    except:
        return 4000.0

class Body:
    def __init__(self, x_pix, y_pix, vel_x, vel_y, mass, img=None, size=5, color="red", is_planet=False, radius_m=None):
        self.x_m = x_pix * PIXEL_TO_M
        self.y_m = y_pix * PIXEL_TO_M
        self.vel_x = vel_x
        self.vel_y = vel_y
        self.mass = mass
        self.img = img
        self.size = size
        self.color = color
        self.is_planet = is_planet
        self.radius_m = radius_m if radius_m else (size/2)*PIXEL_TO_M
        self.trail = []
        self.alive = True

    def apply_gravity(self, others, G):
        for other in others:
            if other is self:
                continue
            dx, dy = other.x_m - self.x_m, other.y_m - self.y_m
            r = math.hypot(dx, dy)
            # Add a minimum distance to prevent extreme forces
            min_distance = other.radius_m * 1.1
            if r < min_distance:
                r = min_distance
            if r <= other.radius_m and not self.is_planet:
                self.alive = False
                return
            a = G * other.mass / (r*r)
            time_step = get_time_step()
            self.vel_x += a * (dx/r) * time_step
            self.vel_y += a * (dy/r) * time_step

    def update(self):
        time_step = get_time_step()
        self.x_m += self.vel_x * time_step
        self.y_m += self.vel_y * time_step
        self.trail.append((self.x_m/PIXEL_TO_M, self.y_m/PIXEL_TO_M))
        if len(self.trail) > MAX_TRAIL:
            self.trail.pop(0)

    def draw(self):
        px, py = self.x_m/PIXEL_TO_M, self.y_m/PIXEL_TO_M
        for (tx,ty) in self.trail:
            ctx.fillStyle = "rgba(200,200,200,0.35)"
            ctx.fillRect(tx, ty, 2, 2)
        if self.is_planet and self.img:
            ctx.drawImage(self.img, px-self.size/2, py-self.size/2, self.size, self.size)
        else:
            ctx.beginPath(); ctx.fillStyle=self.color
            ctx.arc(px, py, self.size, 0, math.pi*2); ctx.fill()
            speed = math.hypot(self.vel_x, self.vel_y)
            ctx.fillStyle="lime"; ctx.fillText(f"{speed:.1f} m/s", px+8, py-8)

bodies=[]
temp_obj_pos=None; preview_line=None

def setup_planets():
    global bodies
    # Keep only planets (remove ships)
    bodies = [b for b in bodies if b.is_planet]
    
    count = int(planet_count.value)
    pmass1 = get_value(planet1_base, planet1_exp, 1.90e27)
    pmass2 = get_value(planet2_base, planet2_exp, 6.39e23)

    def mass_to_size(mass):
        base_size = 60  # Reduced base size
        scale = 8       # Reduced scale factor
        return base_size + scale * math.log10(max(mass/1e24, 1))

    # Remove existing planets
    bodies = [b for b in bodies if not b.is_planet]
    
    if count == 1:
        size1 = mass_to_size(pmass1)
        planet = Body(
            WIDTH/2, HEIGHT/2, 0,0,
            pmass1,
            img=jupiter_img, size=size1,
            color="orange", is_planet=True,
            radius_m=(size1/2)*PIXEL_TO_M
        )
        bodies.append(planet)
    else:
        size1 = mass_to_size(pmass1)
        size2 = mass_to_size(pmass2)

        # First planet (Jupiter)
        left = Body(
            WIDTH/2 - 450, HEIGHT/2, 0,0,  # Increased distance between planets
            pmass1,
            img=jupiter_img, size=size1,
            color="orange", is_planet=True,
            radius_m=(size1/2)*PIXEL_TO_M
        )
        # Second planet (Mars)
        right = Body(
            WIDTH/2 + 450, HEIGHT/2, 0,0,  # Increased distance between planets
            pmass2,
            img=mars_img, size=size2,
            color="orange", is_planet=True,
            radius_m=(size2/2)*PIXEL_TO_M
        )
        bodies.extend([left, right])

# Create a global flag to trigger planet setup from the main loop
planet_count_changed = False

def update_planet_count():
    global planet_count_changed
    planet_count_changed = True

# Expose this function to JavaScript
window.update_planet_count = update_planet_count

setup_planets()

def loop(*args):
    global bodies, planet_count_changed
    
    # Check if planet count has changed and update if needed
    if planet_count_changed:
        setup_planets()
        planet_count_changed = False
    
    ctx.clearRect(0,0,WIDTH,HEIGHT)
    try: ctx.drawImage(bg_img,0,0,WIDTH,HEIGHT)
    except: pass

    pmass1 = get_value(planet1_base, planet1_exp, 1.90e27)
    pmass2 = get_value(planet2_base, planet2_exp, 6.39e23)
    smass = get_value(ship_base, ship_exp, 1e3)
    G = get_value(grav_base, grav_exp, 6.67e-11)

    # Update time step display
    current_time_step = get_time_step()
    time_step_value.innerText = f"{current_time_step:.1f}"

    planet1_real.innerText=f"{pmass1:.3e} kg"
    planet2_real.innerText=f"{pmass2:.3e} kg" if int(planet_count.value)==2 else ""
    ship_real.innerText=f"{smass:.3e} kg"
    grav_real.innerText=f"{G:.3e}"

    if preview_line:
        start,end=preview_line
        ctx.strokeStyle="lime"; ctx.beginPath()
        ctx.moveTo(start[0],start[1]); ctx.lineTo(end[0],end[1]); ctx.stroke()
        dx,dy=end[0]-start[0], end[1]-start[1]
        v=math.hypot(dx,dy)*DRAG_TO_V
        ctx.fillStyle="yellow"; ctx.fillText(f"{v:.1f} m/s", end[0]+10, end[1]-10)

    new_bodies=[]
    for b in list(bodies):
        if not b.is_planet and b.alive:
            b.apply_gravity([x for x in bodies if x.is_planet], G)
            if b.alive:
                b.update()
        if b.alive:
            new_bodies.append(b)
            b.draw()
    bodies=new_bodies
    window.requestAnimationFrame(loop_proxy)

def on_mousedown(evt):
    global temp_obj_pos, preview_line
    if temp_obj_pos is None:
        temp_obj_pos=(evt.offsetX, evt.offsetY)
        preview_line=(temp_obj_pos,temp_obj_pos)
    else:
        dx=evt.offsetX-temp_obj_pos[0]; dy=evt.offsetY-temp_obj_pos[1]
        smass = get_value(ship_base, ship_exp, 1e3)
        ship=Body(temp_obj_pos[0], temp_obj_pos[1], dx*DRAG_TO_V, dy*DRAG_TO_V, smass)
        bodies.append(ship)
        temp_obj_pos=None; preview_line=None

def on_mousemove(evt):
    global preview_line
    if preview_line: preview_line=(preview_line[0], (evt.offsetX, evt.offsetY))

def reset_ships(evt=None):
    global bodies
    planets=[b for b in bodies if b.is_planet]
    bodies=list(planets)

def restart(evt):
    # Get current planet count before resetting
    current_count = planet_count.value
    
    # Reset values to defaults
    planet1_base.value, planet1_exp.value = str(DEFAULT_PLANET1[0]), str(DEFAULT_PLANET1[1])
    planet2_base.value, planet2_exp.value = str(DEFAULT_PLANET2[0]), str(DEFAULT_PLANET2[1])
    ship_base.value, ship_exp.value = str(DEFAULT_SHIP[0]), str(DEFAULT_SHIP[1])
    grav_base.value, grav_exp.value = str(DEFAULT_G[0]), str(DEFAULT_G[1])
    time_step_scale.value = "40"
    
    # Keep the current planet count
    planet_count.value = current_count
    
    # Update UI based on current count
    document.getElementById("planet2Row").style.display = "flex" if current_count == "2" else "none"
    
    # Recreate planets with new values
    setup_planets()

canvas.addEventListener("mousedown", create_proxy(on_mousedown))
canvas.addEventListener("mousemove", create_proxy(on_mousemove))
reset_btn.addEventListener("click", create_proxy(reset_ships))
restart_btn.addEventListener("click", create_proxy(restart))

loop_proxy=create_proxy(loop)
window.requestAnimationFrame(loop_proxy)
  </script>

  <!-- Menu JS -->
  <script>
    const startBtn = document.getElementById("startBtn");
    const instBtn = document.getElementById("instBtn");
    const ui = document.getElementById("ui");
    const canvas = document.getElementById("sim");
    const instBox = document.getElementById("instructionsBox");
    const planetCount = document.getElementById("planetCount");
    const planet2Row = document.getElementById("planet2Row");
    const timeStepScale = document.getElementById("timeStepScale");
    const timeStepValue = document.getElementById("timeStepValue");

    startBtn.onclick = () => {
      ui.style.display = "block";
      canvas.style.display = "block";
      document.getElementById("menu").style.display = "none";
    };
    instBtn.onclick = () => {
      instBox.style.display = (instBox.style.display === "block" ? "none" : "block");
    };
    planetCount.onchange = () => {
      planet2Row.style.display = (planetCount.value === "2") ? "flex" : "none";
      
      // Call the Python function to update planet count
      if (window.update_planet_count) {
        window.update_planet_count();
      }
    };
    
    // Update time step value display
    timeStepScale.oninput = () => {
      const scale = parseFloat(timeStepScale.value);
      timeStepValue.textContent = (scale * 100).toFixed(1);
    };
  </script>
</body>
</html>
