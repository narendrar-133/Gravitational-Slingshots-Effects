<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Gravitational Slingshot Simulation</title>
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
  <style>
    body {
      margin: 0;
      background: #0a0a0a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    #menu { margin-top: 50px; text-align: center; }
    #menu button {
      background: #1e90ff; border: none; color: white; font-weight: 600; font-size: 18px;
      padding: 12px 28px; margin: 0 15px; border-radius: 8px; cursor: pointer;
      box-shadow: 0 4px 8px rgba(30,144,255,0.4);
    }
    #menu button:hover { background: #3ea0ff; }
    #ui { display:none; background:#121212; padding:20px; border-radius:16px; margin:20px; }
    #ui label { display:flex; align-items:center; margin-bottom:12px; }
    #ui input, #ui select { margin-left:10px; background:#222; color:#eee; border:1px solid #444; border-radius:6px; padding:4px 8px; width:100px; }
    #ui button { background:#1e90ff; color:white; border:none; border-radius:8px; padding:8px 16px; margin:0 10px; cursor:pointer; }
    #ui button:hover { background:#3ea0ff; }
    .value { margin-left:12px; font-family:monospace; color:#ffd633; }
    canvas { display:none; border:2px solid #1e90ff; border-radius:12px; background:black; }
  </style>
</head>
<body>
  <div id="menu">
    <button id="startBtn">Start Simulation</button>
  </div>

  <div id="ui">
    <label>Planet 1 Mass (kg):
      <input type="text" id="planet1" value="1.00e27" />
    </label>
    <label>Planet 2 Mass (kg):
      <input type="text" id="planet2" value="1.00e27" />
    </label>
    <label>Ship Mass (kg):
      <input type="text" id="ship" value="1.0e3" />
    </label>
    <label>G (N·m²/kg²):
      <input type="text" id="grav" value="6.67e-11" />
    </label>
    <label>Number of Planets:
      <select id="planetCount">
        <option value="1">1</option>
        <option value="2" selected>2</option>
      </select>
    </label>
    <div>
      <button id="reset">Reset Ships</button>
      <button id="restart">Restart Defaults</button>
    </div>
  </div>

  <canvas id="sim" width="1280" height="720"></canvas>

  <script type="py">
import math
from js import document, window, Image
from pyodide.ffi import create_proxy

WIDTH, HEIGHT = 1280, 720
canvas = document.getElementById("sim")
ctx = canvas.getContext("2d")

planet1 = document.getElementById("planet1")
planet2 = document.getElementById("planet2")
ship_el = document.getElementById("ship")
grav_el = document.getElementById("grav")
planet_count = document.getElementById("planetCount")
reset_btn = document.getElementById("reset")
restart_btn = document.getElementById("restart")

bg_img = Image.new(); bg_img.src = "background.png"
jupiter_img = Image.new(); jupiter_img.src = "jupiter.png"
mars_img = Image.new(); mars_img.src = "mars.jpg"

PIXEL_TO_M = 1e7
DRAG_TO_V = 0.5
MAX_TRAIL = 300

def get_value(el, fallback):
    try:
        return float(el.value)
    except:
        return fallback

def get_time_step():
    return 2000.0  # fixed for stability

class Body:
    def __init__(self, x_pix, y_pix, vel_x, vel_y, mass, img=None, size=5, color="red", is_planet=False, radius_m=None):
        self.x_m = x_pix * PIXEL_TO_M
        self.y_m = y_pix * PIXEL_TO_M
        self.vel_x = vel_x
        self.vel_y = vel_y
        self.mass = mass
        self.img = img
        self.size = size
        self.color = color
        self.is_planet = is_planet
        self.radius_m = radius_m if radius_m else (size/2)*PIXEL_TO_M
        self.trail = []
        self.alive = True

    def apply_gravity(self, planets, G):
        total_ax = total_ay = 0
        for p in planets:
            dx, dy = p.x_m - self.x_m, p.y_m - self.y_m
            r = math.hypot(dx, dy)
            if r < p.radius_m:
                # collision → destroy ship
                self.alive = False
                return
            force = G * p.mass / (r*r)
            ax = force * (dx / r)
            ay = force * (dy / r)
            total_ax += ax
            total_ay += ay
        dt = get_time_step()
        self.vel_x += total_ax * dt
        self.vel_y += total_ay * dt

    def update(self):
        dt = get_time_step()
        self.x_m += self.vel_x * dt
        self.y_m += self.vel_y * dt
        self.trail.append((self.x_m/PIXEL_TO_M, self.y_m/PIXEL_TO_M))
        if len(self.trail) > MAX_TRAIL:
            self.trail.pop(0)

    def draw(self):
        px, py = self.x_m/PIXEL_TO_M, self.y_m/PIXEL_TO_M
        for (tx,ty) in self.trail:
            ctx.fillStyle = "rgba(200,200,200,0.35)"
            ctx.fillRect(tx, ty, 2, 2)
        if self.is_planet and self.img:
            ctx.drawImage(self.img, px-self.size/2, py-self.size/2, self.size, self.size)
        else:
            ctx.beginPath()
            ctx.fillStyle = self.color
            ctx.arc(px, py, self.size, 0, math.pi*2)
            ctx.fill()

bodies = []
temp_pos = None
preview_line = None

def setup_planets():
    global bodies
    bodies = [b for b in bodies if not b.is_planet]  # clear planets
    count = int(planet_count.value)
    m1 = get_value(planet1, 1.00e27)
    m2 = get_value(planet2, 1.00e27)

    def mass_to_size(m):
        return 40 + 10 * math.log10(max(m/1e24, 1))

    bodies = [b for b in bodies if not b.is_planet]

    if count == 1:
        size = mass_to_size(m1)
        planet = Body(WIDTH/2, HEIGHT/2, 0,0, m1, img=jupiter_img, size=size, color="orange", is_planet=True, radius_m=(size/2)*PIXEL_TO_M)
        bodies.append(planet)
    else:
        size1 = mass_to_size(m1)
        size2 = mass_to_size(m2)
        left = Body(WIDTH/2 - 400, HEIGHT/2, 0,0, m1, img=jupiter_img, size=size1, color="orange", is_planet=True, radius_m=(size1/2)*PIXEL_TO_M)
        right = Body(WIDTH/2 + 400, HEIGHT/2, 0,0, m2, img=mars_img, size=size2, color="orange", is_planet=True, radius_m=(size2/2)*PIXEL_TO_M)
        bodies.extend([left, right])

setup_planets()

def loop(*args):
    ctx.clearRect(0,0,WIDTH,HEIGHT)
    try: ctx.drawImage(bg_img,0,0,WIDTH,HEIGHT)
    except: pass

    G = get_value(grav_el, 6.67e-11)
    planets = [b for b in bodies if b.is_planet]
    new_bodies = []

    if preview_line:
        start, end = preview_line
        ctx.strokeStyle="lime"
        ctx.beginPath()
        ctx.moveTo(start[0], start[1])
        ctx.lineTo(end[0], end[1])
        ctx.stroke()
        dx, dy = end[0]-start[0], end[1]-start[1]
        v = math.hypot(dx,dy)*DRAG_TO_V
        ctx.fillStyle="yellow"
        ctx.fillText(f"{v:.1f} m/s", end[0]+10, end[1]-10)

    for b in list(bodies):
        if not b.is_planet and b.alive:
            b.apply_gravity(planets, G)
            if b.alive:
                b.update()
        if b.alive:
            new_bodies.append(b)
            b.draw()
    bodies[:] = new_bodies
    window.requestAnimationFrame(loop_proxy)

def on_mousedown(evt):
    global temp_pos, preview_line
    if temp_pos is None:
        temp_pos = (evt.offsetX, evt.offsetY)
        preview_line = (temp_pos, temp_pos)
    else:
        dx = evt.offsetX - temp_pos[0]
        dy = evt.offsetY - temp_pos[1]
        smass = get_value(ship_el, 1e3)
        ship = Body(temp_pos[0], temp_pos[1], dx*DRAG_TO_V, dy*DRAG_TO_V, smass)
        bodies.append(ship)
        temp_pos = None
        preview_line = None

def on_mousemove(evt):
    global preview_line
    if preview_line:
        preview_line = (preview_line[0], (evt.offsetX, evt.offsetY))

def reset_ships(evt=None):
    global bodies
    planets = [b for b in bodies if b.is_planet]
    bodies = list(planets)

def restart(evt):
    planet1.value = "1.00e27"
    planet2.value = "1.00e27"
    ship_el.value = "1.0e3"
    grav_el.value = "6.67e-11"
    setup_planets()

canvas.addEventListener("mousedown", create_proxy(on_mousedown))
canvas.addEventListener("mousemove", create_proxy(on_mousemove))
reset_btn.addEventListener("click", create_proxy(reset_ships))
restart_btn.addEventListener("click", create_proxy(restart))

loop_proxy = create_proxy(loop)
window.requestAnimationFrame(loop_proxy)
  </script>

  <script>
    const startBtn = document.getElementById("startBtn");
    const ui = document.getElementById("ui");
    const canvas = document.getElementById("sim");

    startBtn.onclick = () => {
      ui.style.display = "block";
      canvas.style.display = "block";
      document.getElementById("menu").style.display = "none";
    };
  </script>
</body>
</html>
