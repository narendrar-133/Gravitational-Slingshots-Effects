<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Gravitational Slingshot Simulation</title>
  <script type="module" src="https://pyscript.net/releases/2024.1.1/core.js"></script>
  <style>
    body {
      margin: 0;
      background: #0a0a0a;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #eee;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      align-items: center;
      justify-content: flex-start;
      padding: 20px;
    }
    #menu { margin-top: 50px; text-align: center; }
    #menu button {
      background: #1e90ff; border: none; color: white; font-weight: 600; font-size: 18px;
      padding: 12px 28px; margin: 0 15px; border-radius: 8px; cursor: pointer;
      box-shadow: 0 4px 8px rgba(30,144,255,0.4);
    }
    #menu button:hover { background: #3ea0ff; }
    #instructionsBox { display:none; max-width:600px; background:#1a1a1a; padding:20px; border-radius:12px; margin:20px; }
    #instructionsBox h3 { color:#1e90ff; text-align:center; }
    #ui { display:none; background:#121212; padding:20px; border-radius:16px; margin:20px; }
    #ui label { display:flex; align-items:center; margin-bottom:12px; }
    #ui input { margin-left:10px; background:#222; color:#eee; border:1px solid #444; border-radius:6px; padding:4px 8px; width:200px; }
    #ui button { background:#1e90ff; color:white; border:none; border-radius:8px; padding:8px 16px; margin:0 10px; cursor:pointer; }
    #ui button:hover { background:#3ea0ff; }
    .value { margin-left:12px; font-family:monospace; color:#ffd633; }
    canvas { display:none; border:2px solid #1e90ff; border-radius:12px; background:black; }
  </style>
</head>
<body>
  <!-- Start Menu -->
  <div id="menu">
    <button id="startBtn">Start Simulation</button>
    <button id="instBtn">Show Instructions</button>
  </div>

  <!-- Instructions -->
  <div id="instructionsBox">
    <h3>Simulation Instructions</h3>
    <ul>
      <li>Click once on the canvas → red dot marks the ship’s starting position.</li>
      <li>Move the mouse → a green line shows launch velocity direction & magnitude.</li>
      <li>Click again → ship is launched with shown velocity (in m/s).</li>
      <li>Planet is fixed at the center; gravitational force acts on ships.</li>
      <li>You can change Planet Mass, Ship Mass, and G directly using scientific notation (e.g., 5.97e24, 1e3, 6.67e-11).</li>
    </ul>
  </div>

  <!-- UI -->
  <div id="ui">
    <label>Planet Mass (kg):
      <input type="text" id="planetMass" value="5.97e24" />
      <span id="planetReal" class="value"></span>
    </label>
    <label>Ship Mass (kg):
      <input type="text" id="shipMass" value="1e3" />
      <span id="shipReal" class="value"></span>
    </label>
    <label>G (N·m²/kg²):
      <input type="text" id="grav" value="6.67e-11" />
      <span id="gravReal" class="value"></span>
    </label>
    <div>
      <button id="reset">Reset Ships</button>
      <button id="restart">Restart Defaults</button>
    </div>
  </div>

  <!-- Canvas -->
  <canvas id="sim" width="1280" height="720"></canvas>

  <!-- Python -->
  <script type="py">
import math
from js import document, window, Image
from pyodide.ffi import create_proxy

WIDTH, HEIGHT = 1280, 720
canvas = document.getElementById("sim")
ctx = canvas.getContext("2d")

planet_input = document.getElementById("planetMass")
ship_input = document.getElementById("shipMass")
grav_input = document.getElementById("grav")

planet_real_span = document.getElementById("planetReal")
ship_real_span = document.getElementById("shipReal")
grav_real_span = document.getElementById("gravReal")

reset_btn = document.getElementById("reset")
restart_btn = document.getElementById("restart")

bg_img = Image.new(); bg_img.src = "background.png"
planet_img = Image.new(); planet_img.src = "jupiter.png"

PIXEL_TO_M = 1e6
TIME_STEP = 4000.0
DRAG_TO_V = 2
MAX_TRAIL = 300
PLANET_IMG_SIZE = 120
PLANET_RADIUS_M = (PLANET_IMG_SIZE/2) * PIXEL_TO_M   # collision cutoff

DEFAULT_PLANET_MASS = 5.97e24
DEFAULT_G = 6.67e-11
DEFAULT_SHIP_MASS = 1e3

def get_value(base_el, fallback):
    try:
        return float(str(base_el.value))
    except:
        return fallback

class Body:
    def __init__(self, x_pix, y_pix, vel_x, vel_y, mass, size=5, color="red", is_planet=False):
        self.x_m = x_pix * PIXEL_TO_M
        self.y_m = y_pix * PIXEL_TO_M
        self.vel_x = vel_x
        self.vel_y = vel_y
        self.mass = mass
        self.size = size
        self.color = color
        self.is_planet = is_planet
        self.trail = []
        self.alive = True  # track if ship is alive

    def apply_gravity(self, others, G):
        for other in others:
            if other is self: 
                continue
            dx, dy = other.x_m - self.x_m, other.y_m - self.y_m
            r = math.hypot(dx, dy)
            # Collision check
            if r <= PLANET_RADIUS_M and not self.is_planet:
                self.alive = False   # mark ship as destroyed
                return
            a = G * other.mass / (r*r)
            self.vel_x += a * (dx/r) * TIME_STEP
            self.vel_y += a * (dy/r) * TIME_STEP

    def update(self):
        self.x_m += self.vel_x * TIME_STEP
        self.y_m += self.vel_y * TIME_STEP
        self.trail.append((self.x_m/PIXEL_TO_M, self.y_m/PIXEL_TO_M))
        if len(self.trail) > MAX_TRAIL: 
            self.trail.pop(0)

    def draw(self):
        px, py = self.x_m/PIXEL_TO_M, self.y_m/PIXEL_TO_M
        for (tx,ty) in self.trail:
            ctx.fillStyle = "rgba(200,200,200,0.35)"
            ctx.fillRect(tx, ty, 2, 2)
        if self.is_planet:
            ctx.drawImage(planet_img, px-PLANET_IMG_SIZE/2, py-PLANET_IMG_SIZE/2, PLANET_IMG_SIZE, PLANET_IMG_SIZE)
        else:
            ctx.beginPath(); ctx.fillStyle=self.color
            ctx.arc(px, py, self.size, 0, math.pi*2); ctx.fill()
            speed = math.hypot(self.vel_x, self.vel_y)
            ctx.fillStyle="lime"; ctx.fillText(f"{speed:.1f} m/s", px+8, py-8)

planet = Body(WIDTH/2, HEIGHT/2, 0,0, DEFAULT_PLANET_MASS, size=10, color="orange", is_planet=True)
bodies=[planet]
temp_obj_pos=None; preview_line=None

def loop(*args):
    global bodies
    ctx.clearRect(0,0,WIDTH,HEIGHT)
    try: 
        ctx.drawImage(bg_img,0,0,WIDTH,HEIGHT)
    except: 
        pass

    # update values from UI
    planet.mass = get_value(planet_input, DEFAULT_PLANET_MASS)
    G = get_value(grav_input, DEFAULT_G)
    ship_mass = get_value(ship_input, DEFAULT_SHIP_MASS)
    planet_real_span.innerText=f"{planet.mass:.3e} kg"
    ship_real_span.innerText=f"{ship_mass:.3e} kg"
    grav_real_span.innerText=f"{G:.3e}"

    # preview launch line
    if preview_line:
        start,end=preview_line
        ctx.strokeStyle="lime"; ctx.beginPath()
        ctx.moveTo(start[0],start[1]); ctx.lineTo(end[0],end[1]); ctx.stroke()
        dx,dy=end[0]-start[0], end[1]-start[1]
        v=math.hypot(dx,dy)*DRAG_TO_V
        ctx.fillStyle="yellow"; ctx.fillText(f"{v:.1f} m/s", end[0]+10, end[1]-10)

    # update bodies
    new_bodies=[]
    for b in list(bodies):
        if not b.is_planet and b.alive:
            b.apply_gravity([planet], G)
            if b.alive:  # only update if not destroyed
                b.update()
        if b.alive:
            new_bodies.append(b)
            b.draw()
    bodies = new_bodies

    window.requestAnimationFrame(loop_proxy)

def on_mousedown(evt):
    global temp_obj_pos, preview_line
    if temp_obj_pos is None:
        temp_obj_pos=(evt.offsetX, evt.offsetY)
        preview_line=(temp_obj_pos,temp_obj_pos)
    else:
        dx=evt.offsetX-temp_obj_pos[0]; dy=evt.offsetY-temp_obj_pos[1]
        ship=Body(temp_obj_pos[0], temp_obj_pos[1], dx*DRAG_TO_V, dy*DRAG_TO_V,
                  get_value(ship_input, DEFAULT_SHIP_MASS))
        bodies.append(ship)
        temp_obj_pos=None; preview_line=None

def on_mousemove(evt):
    global preview_line
    if preview_line: preview_line=(preview_line[0], (evt.offsetX, evt.offsetY))

def reset_ships(evt):
    global bodies; bodies=[planet]

def restart(evt):
    global planet,bodies,temp_obj_pos,preview_line
    planet=Body(WIDTH/2,HEIGHT/2,0,0,DEFAULT_PLANET_MASS, size=10,color="orange",is_planet=True)
    bodies=[planet]; temp_obj_pos=None; preview_line=None

    planet_input.value = "5.97e24"
    ship_input.value = "1e3"
    grav_input.value = "6.67e-11"

    planet_real_span.innerText = f"{DEFAULT_PLANET_MASS:.3e} kg"
    ship_real_span.innerText = f"{DEFAULT_SHIP_MASS:.3e} kg"
    grav_real_span.innerText = f"{DEFAULT_G:.3e}"

canvas.addEventListener("mousedown", create_proxy(on_mousedown))
canvas.addEventListener("mousemove", create_proxy(on_mousemove))
reset_btn.addEventListener("click", create_proxy(reset_ships))
restart_btn.addEventListener("click", create_proxy(restart))

loop_proxy=create_proxy(loop)
window.requestAnimationFrame(loop_proxy)
  </script>

  <!-- Menu JS -->
  <script>
    const startBtn=document.getElementById("startBtn");
    const instBtn=document.getElementById("instBtn");
    const ui=document.getElementById("ui");
    const canvas=document.getElementById("sim");
    const instBox=document.getElementById("instructionsBox");
    startBtn.onclick=()=>{ui.style.display="block";canvas.style.display="block";document.getElementById("menu").style.display="none";};
    instBtn.onclick=()=>{instBox.style.display=(instBox.style.display==="block"?"none":"block");};
  </script>
</body>
</html>
